# 操作系统大作业——实现一个文件系统



本次大作业实现了一个简单的文件系统，使用的是基于Ext的文件系统进行模拟开发。其中主要的数据结构包括SuperBlock、Inode、Fcb以及FcbLink，使用模块化开发。

## 数据结构

### SuperBlock

SuperBlock是管理文件系统信息的地方，**记录了包括Inode节点的数量、Block的数量以及当前还剩余多少可用的空间**，它的定义以及数据结构如下：

![img](https://i.loli.net/2021/03/26/m9VrGfZRHvBFnqP.jpg)



### Inode

Inode节点是具体到**对应某一个文件或者目录的索引结构，也保存了文件或者目录的具体信息，包括时间，大小等等，通过Inode节点，我们可以查询到该文件存储的Block位置，并且能够获取该节点的文件控制块**，他的定义以及数据结构如下：

![img](https://i.loli.net/2021/03/26/lOHAqeM6aTF42Gf.jpg)



**Inode节点索引结构**

![img](https://i.loli.net/2021/03/26/u9cDUCd3EovtBfn.jpg)

### FcbLink

文件链表FcbLink的定义如下：

![img](https://i.loli.net/2021/03/26/ShumgRzqKCjoxBW.jpg)



### User

User是用户数据结构，用户的数据结构由用户的用户名以及用户密码构成，并且用户账号与密码的长度都是10个字节，下面是用户数据结构的定义

![img](https://i.loli.net/2021/03/26/QJY1LsjR7BIbUdC.jpg)

### Block

面的数据结构是作为管理部分的数据结构，而用于存储的数据结构为Block，Block是指定的大小空间，我们有多个Block，其中每一个Inode节点都会有一个对应的Block的Id，用于访问对应的Block数据。

每一个Block的数据抽象图如下：

![img](https://i.loli.net/2021/03/26/vUoHIwTWLCiZ6hA.jpg)



对于每一个Block的内部，每一个4B表示一个项Item，可以用于存储id获取文件的数据

![img](https://i.loli.net/2021/03/26/sOeLUQlyD4SCuV2.jpg)







## 文件系统基本架构

### 基本架构

![img](https://i.loli.net/2021/03/26/eD6Lr2PuUvFgIZi.jpg)

这里我的数据区的BlockSize = 1Kb,BlockNum = 100MB / 1KB = 102400；我们总的内存空间是100MB，但是我们依然需要存储其他管理额数据例如User、SuperBlock的数据，这些数据也占用100MB的内存；我为了不超出100MB的内存空间，在每一次创建文件或者写入文件的时候，我都判断文件的指针是否超过了100MB的结束位置的地方，假如超过了文件100MB的位置，我就不进行这个操作，返回内存空间不足。

### 基本模块

![img](https://i.loli.net/2021/03/26/CbFU9T4I7GxP2Ak.jpg)





## 流程

### 创建文件

![img](https://i.loli.net/2021/03/26/JvG9tECcmqdR1B2.jpg)

### 删除文件

![img](https://i.loli.net/2021/03/26/toYy2RA3ELnI97K.jpg)



### 文件读写复制访问

定义`Fsig`数据结构，将`Fsig`结构封装到Inode节点

![img](https://i.loli.net/2021/03/26/n3JdvButbz6cpew.jpg)



在Fsig结构中定义两个函数，分别为wait函数与signal函数，前者在申请访问文件时候调用，后者在访问完文件之后调用，表示申请资源和释放资源的操作。
Wait函数会检测以下的三种情况的处理：

1.	当前有没有人访问
可以读也可以写，写的话当前访问人数需要加1；，返回成功0
2.	当前有人读
不允许写，可以判断是否可以读，读的人的数量超过最多访问人数则申请资源失败，返回-1，否则当前访问人数+1，返回成功0；
3.	当前有人写
当有人写的时候既不允许读也不允许写，返回失败-1

Signal函数也会处理两种情况：
1.	当前为读操作
假如当前访问人数为1，释放后rw设置为0，表示此时没有读也没有写操作；否则当前人数减1，rw不变，返回成功0
2.	当前为写操作
写操作是独占的，释放的时候将rw设置为0，当前访问人数也设置为0，然后返回成功0.



## 实验总结

**其中本次实验要点包括：**

1. 存储：基于大文件实现，开辟100MB的大文件用于管理内存及数据。

2. 文件逻辑结构：索引顺序文件文件结构，顺序文件中的记录先分为组，为顺序文件建立一张索引表，在索引表里为每组中的第一个记录建立索引项，记录在文件中的位置由索引表和顺序来决定。(提升：二级索引)

3. 文件物理结构： 顺序存储，使用块来保存Block的数据并且块是连续的。

4. 管理：使用位图Bitmap来管理Inode节点以及数据块Block的使用情况，使用char来代表Bitmap的位, 由于内存需要对齐，就算使用bool也是需要占用8个字节

 

**已经实现的功能有：**

1. 多种指令接口：

ls 与 ls –l(显示目录文件与文件夹)、mkdir(创建目录)、open(创建文件)、rmdir(删除目录)、rm(删除文件)、write(写文件)、cat(读文件)、mv(重命名文件)、cd(切换目录)、help(帮助指令)、chmod(更改文件权限)、account(更改账号信息)、logout(登出)、exit (退出)。

2. 使用信号量实现了读写进程的互斥访问

 

**可以改进的地方：**

1. 写大文件

2. 给Inode节点增加二级索引，并且增加二级索引的操作



**最终成果预览**

![文件系统预览](https://i.loli.net/2020/07/09/STyowZ7K9ihfq2O.jpg)

 

**心得：**

这次大作业模拟了Linux下的文件系统管理，花费了大量的时间，对于ext文件系统有了深刻的了解，ext主要是采用一种类似链表的管理模式来管理文件的信息链；用顺存储的模式来保存存储的块。同时，通过这次实验，我也知道了对于这种精细内存的管理，使用C要容易的多，C的指针管理能够做到精确到字节的管理，对于指定数据的访问只要知道一个偏移值及数据的大小就能够得到数据，非常的强大。在这次实验，对于文件管理的认识也进一步的提升了！

 

---

